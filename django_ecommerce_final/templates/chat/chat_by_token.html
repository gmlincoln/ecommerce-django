{% extends 'base.html' %}
{% block title %}Chat - {{ session.user.username }}{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-12">
    <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 flex flex-col h-[700px]">
            <!-- Header -->
            <div class="p-8 border-b border-gray-100 bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md">
                        <i class="fas fa-comments text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black uppercase tracking-tight">Support Chat</h1>
                        <p class="text-sm opacity-90 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            {% if is_owner %}Your conversation{% else %}Viewing {{ other_user.username }}'s chat{% endif
                            %}
                        </p>
                    </div>
                </div>
            </div>

            {% if read_only %}
            <!-- Read-only notice -->
            <div class="px-8 py-4 bg-yellow-50 border-b border-yellow-100">
                <div class="flex items-center gap-3">
                    <i class="fas fa-info-circle text-yellow-600"></i>
                    <p class="text-sm text-yellow-800 font-semibold">
                        You're viewing this chat in read-only mode. Log in as the owner to send messages.
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Messages Area -->
            <div id="token-chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6 bg-gray-50/30">
                <!-- Messages will load here -->
            </div>

            <!-- Input Area -->
            {% if not read_only %}
            <div class="p-8 border-t border-gray-100 bg-white">
                <form id="token-chat-form" class="flex flex-col gap-4">
                    <div id="token-image-preview" class="hidden relative inline-block self-start">
                        <img id="token-preview-img" class="h-20 w-20 object-cover rounded-xl border-2 border-blue-500">
                        <button type="button" id="token-remove-img"
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" id="token-img-btn"
                            class="w-14 h-14 rounded-2xl bg-gray-50 text-gray-400 hover:bg-gray-100 transition-all flex items-center justify-center border border-gray-100 group">
                            <i class="fas fa-image text-xl group-hover:text-blue-500"></i>
                        </button>
                        <input type="file" id="token-image-input" class="hidden" accept="image/*">

                        <input type="text" id="token-chat-input" placeholder="Type your message..."
                            class="flex-1 bg-gray-50 border-gray-100 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none border">

                        <button type="submit"
                            class="bg-blue-600 text-white px-10 rounded-2xl flex items-center justify-center hover:bg-blue-700 transition-all shadow-xl hover:shadow-blue-500/20 active:scale-95 font-bold uppercase tracking-widest text-xs">
                            Send <i class="fas fa-paper-plane ml-3"></i>
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="p-8 border-t border-gray-100 bg-gray-50 text-center">
                <p class="text-gray-500 text-sm">
                    <i class="fas fa-lock mr-2"></i>
                    Message sending is disabled in read-only mode
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const messages_container = document.getElementById('token-chat-messages');
        const userId = {{ other_user.id }
    };
    const isOwner = {{ is_owner| yesno: "true,false" }};
    const readOnly = {{ read_only|default: False | yesno: "true,false" }};

    {% if not read_only %}
    const form = document.getElementById('token-chat-form');
    const input = document.getElementById('token-chat-input');
    const imgInput = document.getElementById('token-image-input');
    const imgBtn = document.getElementById('token-img-btn');
    const imgPreview = document.getElementById('token-image-preview');
    const previewImg = document.getElementById('token-preview-img');
    const removeImg = document.getElementById('token-remove-img');

    // Image handling
    imgBtn.onclick = () => imgInput.click();
    imgInput.onchange = () => {
        const file = imgInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imgPreview.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }
    };
    removeImg.onclick = () => {
        imgInput.value = '';
        imgPreview.classList.add('hidden');
    };
    {% endif %}

    // Load Messages
    async function loadMessages() {
        try {
            const res = await fetch(`/chat/messages/${userId}/`);
            const data = await res.json();

            let html = '';
            data.messages.forEach(msg => {
                const isMe = msg.is_me;
                html += `
                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-slide-in">
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
                            <div class="${isMe ? 'bg-blue-600 text-white rounded-l-3xl rounded-tr-3xl shadow-lg shadow-blue-500/10' : 'bg-white text-gray-800 rounded-r-3xl rounded-tl-3xl shadow-sm border border-gray-100'} p-5">
                                ${msg.image_url ? `<img src="${msg.image_url}" class="rounded-xl mb-3 max-w-full h-auto cursor-pointer" onclick="window.open('${msg.image_url}')">` : ''}
                                ${msg.message ? `<p class="text-sm leading-relaxed">${msg.message}</p>` : ''}
                                <div class="flex items-center gap-2 mt-2 opacity-60">
                                    <p class="text-[9px] font-black uppercase tracking-widest">${msg.created_at}</p>
                                    ${isMe ? '<i class="fas fa-check-double text-[8px]"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (data.messages.length > 0) {
                const isAtBottom = messages_container.scrollHeight - messages_container.scrollTop <= messages_container.clientHeight + 100;
                messages_container.innerHTML = html;
                if (isAtBottom) {
                    messages_container.scrollTop = messages_container.scrollHeight;
                }
            } else {
                messages_container.innerHTML = `
                        <div class="text-center py-20 opacity-40">
                            <i class="fas fa-comment-medical text-4xl mb-4 text-gray-300"></i>
                            <p class="text-sm font-bold uppercase tracking-wider text-gray-400">No messages yet</p>
                        </div>
                    `;
            }
        } catch (err) { console.error(err); }
    }

    {% if not read_only %}
    // Send Message
    form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        const imageFile = imgInput.files[0];
        if (!text && !imageFile) return;

        const formData = new FormData();
        if (text) formData.append('message', text);
        if (imageFile) formData.append('image', imageFile);
        formData.append('receiver_id', userId);

        input.value = '';
        imgInput.value = '';
        imgPreview.classList.add('hidden');

        try {
            const res = await fetch('/chat/send/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            if (res.ok) {
                loadMessages();
                setTimeout(() => {
                    messages_container.scrollTop = messages_container.scrollHeight;
                }, 100);
            }
        } catch (err) { console.error(err); }
    };
    {% endif %}

    // Initial load and Polling
    loadMessages().then(() => {
        messages_container.scrollTop = messages_container.scrollHeight;
    });
    setInterval(loadMessages, 5000);
    });
</script>

<style>
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
    }
</style>
{% endblock %}