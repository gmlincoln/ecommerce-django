{% extends 'custom_admin/base_admin.html' %}
{% block title %}Chat with {{ other_user.get_full_name|default:other_user.username }}{% endblock %}
{% block page_title %}Support: {{ other_user.get_full_name|default:other_user.username }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex">
        <!-- Sidebar: User List (Mini) -->
        <div
            class="w-1/4 border-r border-gray-100 dark:border-gray-700 hidden lg:block bg-gray-50/30 dark:bg-gray-900/10">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <a href="{% url 'chat:admin_chat_list' %}"
                    class="text-xs font-black text-blue-600 uppercase flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> All Chats
                </a>
            </div>
            <div class="p-4">
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
                    <p class="text-[10px] font-black text-blue-600 dark:text-blue-400 uppercase mb-2">Customer Info</p>
                    <p class="text-sm font-bold text-gray-900 dark:text-white">
                        {{ other_user.get_full_name|default:other_user.username }}</p>
                    <p class="text-[10px] text-gray-500 italic">@{{ other_user.username }}</p>
                </div>
            </div>
        </div>

        <!-- Detail Area -->
        <div class="flex-1 flex flex-col h-[650px]">
            <!-- Header -->
            <div
                class="p-6 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 z-10">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold">
                        {{ other_user.username|first|upper }}
                    </div>
                    <div>
                        <h3 class="font-black text-gray-900 dark:text-white uppercase tracking-wider text-sm">
                            {{ other_user.get_full_name|default:other_user.username }}
                        </h3>
                        <p class="text-[10px] text-green-500 font-bold flex items-center gap-1">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                            ACTIVE SESSION (@{{ other_user.username }})
                        </p>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="admin-chat-messages"
                class="flex-1 overflow-y-auto p-8 space-y-6 bg-gray-50/50 dark:bg-gray-900/50">
                <!-- Messages dynamic -->
                <div class="flex justify-center py-20 opacity-20">
                    <i class="fas fa-comments text-6xl"></i>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 border-t border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800">
                <form id="admin-chat-form" class="flex flex-col gap-4">
                    <div id="admin-image-preview" class="hidden relative inline-block self-start">
                        <img id="admin-preview-img" class="h-16 w-16 object-cover rounded-xl border-2 border-blue-500">
                        <button type="button" id="admin-remove-img"
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" id="admin-img-btn"
                            class="w-12 h-12 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-400 hover:text-blue-600 transition-all flex items-center justify-center border border-gray-100 dark:border-gray-700">
                            <i class="fas fa-image"></i>
                        </button>
                        <input type="file" id="admin-image-input" class="hidden" accept="image/*">

                        <input type="text" id="admin-chat-input" placeholder="Write a response..."
                            class="flex-1 bg-gray-50 dark:bg-gray-900 border-none rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-blue-500 transition-all outline-none dark:text-white">
                        <button type="submit"
                            class="bg-blue-600 text-white px-8 rounded-2xl flex items-center justify-center hover:bg-blue-700 transition-all shadow-lg active:scale-95 font-bold uppercase tracking-widest text-xs">
                            Send <i class="fas fa-paper-plane ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
    }

    #admin-chat-messages::-webkit-scrollbar {
        width: 4px;
    }

    #admin-chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const messages_container = document.getElementById('admin-chat-messages');
        const form = document.getElementById('admin-chat-form');
        const input = document.getElementById('admin-chat-input');
        const otherUserId = {{ other_user.id }
    };

    const imgInput = document.getElementById('admin-image-input');
    const imgBtn = document.getElementById('admin-img-btn');
    const imgPreview = document.getElementById('admin-image-preview');
    const previewImg = document.getElementById('admin-preview-img');
    const removeImg = document.getElementById('admin-remove-img');

    // Image handling
    imgBtn.onclick = () => imgInput.click();
    imgInput.onchange = () => {
        const file = imgInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imgPreview.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }
    };
    removeImg.onclick = () => {
        imgInput.value = '';
        imgPreview.classList.add('hidden');
    };

    // Load Messages
    async function loadMessages() {
        try {
            const res = await fetch(`{% url 'chat:get_messages_detail' 0 %}`.replace('0', otherUserId));
            const data = await res.json();

            let html = '';
            data.messages.forEach(msg => {
                const isMe = msg.is_me;
                html += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-slide-in">
                            <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
                                <span class="text-[9px] text-gray-400 mb-1 px-2 uppercase font-bold tracking-tighter">${msg.sender_name}</span>
                                <div class="${isMe ? 'bg-blue-600 text-white rounded-l-2xl rounded-tr-2xl shadow-lg shadow-blue-500/10' : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-r-2xl rounded-tl-2xl shadow-sm border border-gray-100 dark:border-gray-700'} p-4">
                                    ${msg.image_url ? `<img src="${msg.image_url}" class="rounded-xl mb-2 max-w-full h-auto cursor-pointer border border-white/10" onclick="window.open('${msg.image_url}')">` : ''}
                                    ${msg.message ? `<p class="text-sm leading-relaxed">${msg.message}</p>` : ''}
                                    <div class="flex items-center justify-end gap-2 mt-2 opacity-40">
                                        <p class="text-[8px] font-bold">${msg.created_at}</p>
                                        ${isMe ? '<i class="fas fa-check-double text-[7px]"></i>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            });

            if (data.messages.length > 0) {
                const isAtBottom = messages_container.scrollHeight - messages_container.scrollTop <= messages_container.clientHeight + 100;
                messages_container.innerHTML = html;
                if (isAtBottom) {
                    messages_container.scrollTop = messages_container.scrollHeight;
                }
            }
        } catch (err) { console.error('Chat load error:', err); }
    }

    // Send Message
    form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        const imageFile = imgInput.files[0];
        if (!text && !imageFile) return;

        const formData = new FormData();
        formData.append('receiver_id', otherUserId);
        if (text) formData.append('message', text);
        if (imageFile) formData.append('image', imageFile);

        // Optimistic clear
        input.value = '';
        imgInput.value = '';
        imgPreview.classList.add('hidden');

        try {
            const res = await fetch('{% url "chat:send_message" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            if (res.ok) {
                await loadMessages();
                messages_container.scrollTop = messages_container.scrollHeight;
            }
        } catch (err) { console.error('Chat send error:', err); }
    };

    // Initial load
    loadMessages().then(() => {
        messages_container.scrollTop = messages_container.scrollHeight;
    });

    // Polling
    setInterval(loadMessages, 4000);
    });
</script>
{% endblock %}