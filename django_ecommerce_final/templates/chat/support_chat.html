{% extends 'base.html' %}
{% block title %}Customer Support{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-12">
    <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 flex flex-col h-[700px]">
            <!-- Header -->
            <div class="p-8 border-b border-gray-100 bg-white flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div
                        class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                        <i class="fas fa-headset text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black text-gray-900 uppercase tracking-tight">Customer Support</h1>
                        <p class="text-sm text-gray-500 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            Admins are online to help you
                        </p>
                    </div>
                </div>
            </div>

            <!-- Unique Chat Link Section -->
            <div class="px-8 py-4 bg-blue-50 border-b border-blue-100">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-bold text-blue-900 uppercase tracking-widest mb-1">Your Unique Chat Link
                        </p>
                        <p class="text-xs text-blue-700">Share this link to access your chat from anywhere</p>
                    </div>
                    <button onclick="copyLink()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
                <div class="mt-3 bg-white rounded-lg p-3 border border-blue-200 flex items-center gap-2">
                    <i class="fas fa-link text-blue-500 text-sm"></i>
                    <input type="text" id="chat-link" value="{{ chat_url }}" readonly
                        class="flex-1 bg-transparent text-xs text-gray-700 font-mono outline-none select-all">
                </div>
            </div>

            <!-- Messages Area -->
            <div id="full-chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6 bg-gray-50/30">
                <!-- Messages will load here -->
            </div>

            <!-- Input Area -->
            <div class="p-8 border-t border-gray-100 bg-white">
                <form id="full-chat-form" class="flex flex-col gap-4">
                    <div id="image-preview" class="hidden relative inline-block self-start">
                        <img id="preview-img" class="h-20 w-20 object-cover rounded-xl border-2 border-blue-500">
                        <button type="button" id="remove-img"
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" id="img-upload-btn"
                            class="w-14 h-14 rounded-2xl bg-gray-50 text-gray-400 hover:bg-gray-100 transition-all flex items-center justify-center border border-gray-100 group">
                            <i class="fas fa-image text-xl group-hover:text-blue-500"></i>
                        </button>
                        <input type="file" id="chat-image-input" class="hidden" accept="image/*">

                        <input type="text" id="full-chat-input" placeholder="How can we help you today?"
                            class="flex-1 bg-gray-50 border-gray-100 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none border">

                        <button type="submit"
                            class="bg-blue-600 text-white px-10 rounded-2xl flex items-center justify-center hover:bg-blue-700 transition-all shadow-xl hover:shadow-blue-500/20 active:scale-95 font-bold uppercase tracking-widest text-xs">
                            Send <i class="fas fa-paper-plane ml-3"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const messages_container = document.getElementById('full-chat-messages');
        const form = document.getElementById('full-chat-form');
        const input = document.getElementById('full-chat-input');
        const imgInput = document.getElementById('chat-image-input');
        const imgBtn = document.getElementById('img-upload-btn');
        const imgPreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeImg = document.getElementById('remove-img');

        // Image handling
        imgBtn.onclick = () => imgInput.click();
        imgInput.onchange = () => {
            const file = imgInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imgPreview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        };
        removeImg.onclick = () => {
            imgInput.value = '';
            imgPreview.classList.add('hidden');
        };

        // Load Messages
        async function loadMessages() {
            try {
                const res = await fetch('{% url "chat:get_messages" %}');
                const data = await res.json();

                let html = '';
                data.messages.forEach(msg => {
                    const isMe = msg.is_me;
                    html += `
                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-slide-in">
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
                            <div class="${isMe ? 'bg-blue-600 text-white rounded-l-3xl rounded-tr-3xl shadow-lg shadow-blue-500/10' : 'bg-white text-gray-800 rounded-r-3xl rounded-tl-3xl shadow-sm border border-gray-100'} p-5">
                                ${msg.image_url ? `<img src="${msg.image_url}" class="rounded-xl mb-3 max-w-full h-auto cursor-pointer" onclick="window.open('${msg.image_url}')">` : ''}
                                ${msg.message ? `<p class="text-sm leading-relaxed">${msg.message}</p>` : ''}
                                <div class="flex items-center gap-2 mt-2 opacity-60">
                                    <p class="text-[9px] font-black uppercase tracking-widest">${msg.created_at}</p>
                                    ${isMe ? '<i class="fas fa-check-double text-[8px]"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                });

                if (data.messages.length > 0) {
                    const isAtBottom = messages_container.scrollHeight - messages_container.scrollTop <= messages_container.clientHeight + 100;
                    messages_container.innerHTML = html;
                    if (isAtBottom) {
                        messages_container.scrollTop = messages_container.scrollHeight;
                    }
                }
            } catch (err) { console.error(err); }
        }

        // Send Message
        form.onsubmit = async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            const imageFile = imgInput.files[0];
            if (!text && !imageFile) return;

            const formData = new FormData();
            if (text) formData.append('message', text);
            if (imageFile) formData.append('image', imageFile);

            input.value = '';
            imgInput.value = '';
            imgPreview.classList.add('hidden');

            try {
                const res = await fetch('{% url "chat:send_message" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                if (res.ok) {
                    loadMessages();
                    setTimeout(() => {
                        messages_container.scrollTop = messages_container.scrollHeight;
                    }, 100);
                }
            } catch (err) { console.error(err); }
        };

        // Initial load and Polling
        loadMessages().then(() => {
            messages_container.scrollTop = messages_container.scrollHeight;
        });
        setInterval(loadMessages, 5000);
    });

    // Copy link function
    function copyLink() {
        const linkInput = document.getElementById('chat-link');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // For mobile

        navigator.clipboard.writeText(linkInput.value).then(() => {
            // Show success feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.classList.add('bg-green-600');
            btn.classList.remove('bg-blue-600');

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-blue-600');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
        });
    }
</script>

<style>
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
    }
</style>
{% endblock %}