{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Checkout" %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">{% trans "Checkout" %}</h1>

    <!-- Order Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Order Items -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">{% trans "Order Summary" %}</h2>

            <div class="border-b pb-4 mb-4">
                {% for id, item in cart_items.items %}
                <div class="flex justify-between mb-3 pb-3 border-b last:border-b-0 last:pb-0 last:mb-0">
                    <div>
                        <p class="font-semibold">{{ item.name }}</p>
                        <p class="text-sm text-gray-600">{% trans "Quantity" %}: {{ item.qty }}</p>
                    </div>
                    <p class="font-semibold">৳ {{ item.price }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="bg-gray-50 p-4 rounded">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">{% trans "Subtotal" %}:</span>
                    <span class="font-semibold">৳ <span id="summary_subtotal">{{ subtotal }}</span></span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">{% trans "Shipping" %}:</span>
                    <span class="font-semibold text-blue-600">৳ <span id="summary_shipping">0</span></span>
                </div>
                <div class="border-t pt-2 mt-2 flex justify-between items-center">
                    <span class="text-lg font-bold">{% trans "Total" %}:</span>
                    <span class="text-2xl font-bold text-blue-600">৳ <span id="summary_total">{{ subtotal
                            }}</span></span>
                </div>
            </div>
        </div>

        <!-- Billing Information -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">{% trans "Billing Information" %}</h2>

            <form method="post">
                {% csrf_token %}

                <!-- Use Default Address Option -->
                {% if default_address.full_name %}
                <div class="mb-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="use_default" name="use_default" class="mr-3"
                            onclick="toggleDefaultAddress()">
                        <label for="use_default" class="font-semibold cursor-pointer">
                            {% trans "Use my default address" %}
                        </label>
                    </div>
                </div>
                {% endif %}

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Full Name" %}</label>
                        <input type="text" name="full_name" value="{{ user.get_full_name|default:user.username }}"
                            class="w-full border border-gray-300 rounded px-4 py-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Email" %}</label>
                        <input type="email" name="email" value="{{ user.email }}"
                            class="w-full border border-gray-300 rounded px-4 py-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Phone" %}</label>
                        <input type="tel" name="phone" class="w-full border border-gray-300 rounded px-4 py-2"
                            placeholder="01xxxxxxxxx" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Address Line 1</label>
                        <input type="text" name="address_line_1" class="w-full border border-gray-300 rounded px-4 py-2"
                            placeholder="{% trans 'Street Address' %}" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Address Line 2 (Optional)</label>
                        <input type="text" name="address_line_2" class="w-full border border-gray-300 rounded px-4 py-2"
                            placeholder="{% trans 'Apartment, suite, unit, building, floor, etc.' %}">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Division" %}</label>
                            <select name="state" id="division_select"
                                class="w-full border border-gray-300 rounded px-4 py-2" required
                                onchange="populateDistricts()">
                                <option value="">{% trans "Select Division" %}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "District" %}</label>
                            <select name="city" id="district_select"
                                class="w-full border border-gray-300 rounded px-4 py-2" required>
                                <option value="">{% trans "Select District" %}</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Postal Code</label>
                            <input type="text" name="postal_code"
                                class="w-full border border-gray-300 rounded px-4 py-2"
                                placeholder="{% trans 'Postal Code' %}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Country" %}</label>
                            <input type="text" name="country" value="Bangladesh"
                                class="w-full border border-gray-300 rounded px-4 py-2" required>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <h3 class="font-bold text-lg mt-6 mb-4">{% trans "Payment Method" %}</h3>

                <div class="space-y-4">
                    <!-- SSL Commerce Option -->
                    <div class="border-2 border-blue-600 rounded-lg p-4 bg-blue-50">
                        <div class="flex items-center">
                            <input type="radio" id="ssl" name="payment_method" value="sslcommerz" checked class="mr-3">
                            <label for="ssl" class="font-semibold cursor-pointer flex-1">
                                <i class="fas fa-credit-card mr-2"></i>{% trans "SSL Commerce (Card/Mobile Banking)" %}
                            </label>
                        </div>
                        <p class="text-sm text-gray-600 ml-6 mt-2">Secure payment gateway for credit cards,
                            debit cards, and mobile banking</p>
                    </div>

                    <!-- Cash on Delivery Option -->
                    <div class="border-2 border-gray-300 rounded-lg p-4 hover:border-green-500 transition-colors">
                        <div class="flex items-center">
                            <input type="radio" id="cod" name="payment_method" value="cod" class="mr-3">
                            <label for="cod" class="font-semibold cursor-pointer flex-1">
                                <i class="fas fa-truck mr-2"></i>Cash on Delivery
                            </label>
                        </div>
                        <p class="text-sm text-gray-600 ml-6 mt-2">Pay when your order is delivered to your
                            doorstep</p>
                    </div>
                </div>

                <!-- Order Notes -->
                <textarea name="order_notes" placeholder="{% trans 'Add order notes (optional)' %}"
                    class="w-full border border-gray-300 rounded px-4 py-2 mt-4" rows="3"></textarea>

                <!-- Proceed Button -->
                <div class="mt-6 space-y-2">
                    <button type="submit"
                        class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-shopping-cart mr-2"></i>{% trans "Place Order" %}
                    </button>

                    <a href="{% url 'cart' %}"
                        class="block text-center bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors">
                        {% trans "Back to Cart" %}
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
    const bdLocations = {
        "Barisal": ["Barisal", "Barguna", "Bhola", "Jhalokati", "Patuakhali", "Pirojpur"],
        "Chittagong": ["Chittagong", "Bandarban", "Brahmanbaria", "Chandpur", "Comilla", "Cox's Bazar", "Feni", "Khagrachari", "Lakshmipur", "Noakhali", "Rangamati"],
        "Dhaka": ["Dhaka", "Faridpur", "Gazipur", "Gopalganj", "Kishoreganj", "Madaripur", "Manikganj", "Munshiganj", "Narayanganj", "Narsingdi", "Rajbari", "Shariatpur", "Tangail"],
        "Khulna": ["Khulna", "Bagerhat", "Chuadanga", "Jessore", "Jhenaidah", "Kushtia", "Magura", "Meherpur", "Narail", "Satkhira"],
        "Mymensingh": ["Mymensingh", "Jamalpur", "Netrokona", "Sherpur"],
        "Rajshahi": ["Rajshahi", "Bogra", "Chapainawabganj", "Joypurhat", "Naogaon", "Natore", "Pabna", "Sirajganj"],
        "Rangpur": ["Rangpur", "Dinajpur", "Gaibandha", "Kurigram", "Lalmonirhat", "Nilphamari", "Panchagarh", "Thakurgaon"],
        "Sylhet": ["Sylhet", "Habiganj", "Moulvibazar", "Sunamganj"]
    };

    function populateDivisions() {
        const divisionSelect = document.getElementById("division_select");
        for (let division in bdLocations) {
            let option = document.createElement("option");
            option.text = division;
            option.value = division;
            divisionSelect.add(option);
        }
    }

    function populateDistricts(selectedDistrict = null) {
        const divisionSelect = document.getElementById("division_select");
        const districtSelect = document.getElementById("district_select");
        const selectedDivision = divisionSelect.value;

        // Clear existing districts
        districtSelect.innerHTML = '<option value="">{% trans "Select District" %}</option>';

        if (selectedDivision && bdLocations[selectedDivision]) {
            bdLocations[selectedDivision].forEach(district => {
                let option = document.createElement("option");
                option.text = district;
                option.value = district;
                districtSelect.add(option);
            });
        }

        if (selectedDistrict) {
            districtSelect.value = selectedDistrict;
        }

        // Update shipping whenever districts are repopulated or changed
        updateShippingCharge();
    }

    function updateShippingCharge() {
        const divisionSelect = document.getElementById("division_select");
        const districtSelect = document.getElementById("district_select");
        const division = divisionSelect.value;
        const district = districtSelect.value;

        let charge = 0;

        if (division && district) {
            if (division === 'Dhaka' && district === 'Dhaka') {
                charge = 40;
            } else if (division === 'Mymensingh') {
                charge = 60;
            } else if (division === 'Chittagong') {
                charge = 120;
            } else {
                charge = 100;
            }
        } else if (division) {
            // Partial update if only division is selected
            if (division === 'Mymensingh') charge = 60;
            else if (division === 'Chittagong') charge = 120;
            else if (division === 'Dhaka') charge = 0; // Wait for district
            else charge = 100;
        }

        const subtotal = parseFloat("{{ subtotal }}");
        const subtotalEl = document.getElementById("summary_subtotal");
        const shippingEl = document.getElementById("summary_shipping");
        const totalEl = document.getElementById("summary_total");

        subtotalEl.textContent = subtotal.toFixed(2);
        shippingEl.textContent = charge;
        totalEl.textContent = (subtotal + charge).toFixed(2);
    }

    // Add event listener for direct district change
    document.getElementById("district_select").addEventListener('change', updateShippingCharge);

    function toggleDefaultAddress() {
        const checkbox = document.getElementById("use_default");
        const divisionSelect = document.getElementById("division_select");
        const districtSelect = document.getElementById("district_select");

        if (checkbox.checked) {
            // Fill fields with default address values from the template
            document.querySelector('[name="full_name"]').value = "{{ default_address.full_name|default:user.get_full_name|default:user.username }}";
            document.querySelector('[name="phone"]').value = "{{ default_address.phone|default:'' }}";
            document.querySelector('[name="address_line_1"]').value = "{{ default_address.address_line_1|default:'' }}";
            document.querySelector('[name="address_line_2"]').value = "{{ default_address.address_line_2|default:'' }}";
            document.querySelector('[name="postal_code"]').value = "{{ default_address.postal_code|default:'' }}";
            document.querySelector('[name="country"]').value = "{{ default_address.country|default:'Bangladesh' }}";

            // Handle dropdowns
            const defaultState = "{{ default_address.state|default:'' }}";
            const defaultCity = "{{ default_address.city|default:'' }}";

            if (defaultState) {
                divisionSelect.value = defaultState;
                populateDistricts(defaultCity);
            }

        } else {
            // Clear address fields but keep user info
            document.querySelector('[name="full_name"]').value = "{{ user.get_full_name|default:user.username }}";
            document.querySelector('[name="phone"]').value = "";
            document.querySelector('[name="address_line_1"]').value = "";
            document.querySelector('[name="address_line_2"]').value = "";
            document.querySelector('[name="postal_code"]').value = "";
            divisionSelect.value = "";
            populateDistricts();
            document.querySelector('[name="country"]').value = "Bangladesh";
        }
    }

    // Initialize the form based on whether default address exists
    document.addEventListener('DOMContentLoaded', function () {
        populateDivisions();
        updateShippingCharge();

        const checkbox = document.getElementById("use_default");
        {% if default_address.full_name %}
        // If default address exists, check the box and fill fields
        if (checkbox) {
            checkbox.checked = true;
            toggleDefaultAddress();
        }
        {% endif %}
    });
</script>
{% endblock %}